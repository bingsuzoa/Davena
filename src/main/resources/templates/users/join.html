<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{Layouts/contents}">
        
	<header layout:fragment="header">
		<th:block th:replace="~{fragments/header :: .leftheader}"></th:block>
	</header>
	
	<section layout:fragment="content" class="d-flex justify-content-center">
		<div class="join-content mt-4">
			<div class="joinDiv d-flex">
				<input type="text" class="join-roomInfo form-control col-7" id="join-idInput" placeholder="ì•„ì´ë”” ì…ë ¥">
				<div class="profile-btn col-5" id="check-duplicateBtn">ì¤‘ë³µí™•ì¸</div>
			</div>
			<div class="d-none" id="duplicateText">ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ IDì…ë‹ˆë‹¤. ë³€ê²½í•´ì£¼ì„¸ìš”.</div>
			<div class="d-none" id="availableText">ì‚¬ìš©ê°€ëŠ¥í•œ IDì…ë‹ˆë‹¤.</div>
			<div class="joinDiv">
				<input type="password" class="join-roomInfo form-control" id="join-PwInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
			</div>
			<div class="joinDiv">
				<input type="password" class="join-roomInfo form-control" id="join-checkPwInput" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
			</div>
			<div class="joinDiv d-flex">
				<input type="text" class="join-roomInfo form-control col-6" id="join-userName" placeholder="ì´ë¦„">
				<label for="imgFile" class="profile-btn col-6 p-0">í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ</label>
				<input type="file" id="imgFile" style="display:none">
			</div>
			<div class="joinDiv">
				<div>
					<input class="dropdown-toggle" id="positionBtn" type="text" data-toggle="dropdown" aria-expanded="false" placeholder="ì§ì±… ì„ íƒ" value="">
		  			<div class="dropdown-menu">
		    			<a class="dropdown-item" href="#" value="join-team-leader">íŒ€ì¥</a>
		    			<a class="dropdown-item" href="#" value="join-team-member">íŒ€ì›</a>
		  			</div>
	  			</div>
			</div>
			<div class="joinDiv">
				<input type="text" class="join-roomInfo form-control" id="join-roomName" placeholder="ë°© ì´ë¦„">
			</div>
			<div class="joinDiv">
				<input type="password" class="join-roomInfo form-control" id="join-roomPw" placeholder="ë°© ë¹„ë°€ë²ˆí˜¸ğŸ”‘">
			</div>
			<div class="joinDiv d-flex justify-content-end">
				<div id="join-accountBtn">ê³„ì •ë§Œë“¤ê¸°</div>
			</div>
		</div>
	</section>
	
	<script layout:fragment ="script">
		//drop-downì˜ valueê°’ ë„£ê¸°
		$(".dropdown-menu > a").on('click',function(){
			$("#positionBtn").attr('value', $(this).text());
		})
		
		//Idì¤‘ë³µí™•ì¸
		$(document).ready(function(){	
    		//ì¤‘ë³µí™•ì¸ ì—¬ë¶€
    		var checkDuplicate = false; 		
    		//ì¤‘ë³µì—¬ë¶€
    		var isDuplicatedId = true;
    		
    		$("#join-idInput").on("input", function(){
    			//ì…ë ¥ì´ ë°”ë€Œë©´ ì¤‘ë³µì²´í¬ë¥¼ ë‹¤ì‹œí•´ì•¼í•¨ , ì¤‘ë³µí™•ì¸ê³¼ì • ì´ˆê¸°í™”
    		
    			checkDuplicate = false;
    			isDuplicatedId = true;
    			$("#availableText").addClass("d-none");
    			$("#duplicateText").addClass("d-none");
    		})
    		$("#check-duplicateBtn").on('click',function(){
    			let id = $("#join-idInput").val();
    			if(id == "") {
    				alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    				return;
    			}
    			
    			$.ajax({
    				type:"get"
    				,url:"/user/duplicate-id"
    				,data:{"join-idInput" : id}
    				,success:function(data){
    					if(data.isDuplicate == true){
    						checkDuplicate = true;
    						isDuplicatedId = true;
    						$("#duplicateText").removeClass("d-none");
    						$("#availableText").addClass("d-none");
    					} else {
    						checkDuplicate = true;
    						isDuplicatedId = false;
    						$("#duplicateText").addClass("d-none");
    						$("#availableText").removeClass("d-none");
    					}
    				}, error:function(){
    					alert("ì¤‘ë³µí™•ì¸ ì—ëŸ¬!");
    				}
    			})
    		})
		//ê³„ì •ë§Œë“¤ê¸°
		$("#join-accountBtn").on('click',function(){
			checkIsRoom = false;
			let id = $("#join-idInput").val();
			let password = $("#join-PwInput").val();
			let Checkpassword = $("#join-checkPwInput").val();
			let name = $("#join-userName").val();
			let imgFile = $("#imgFile")[0].files[0];
			let position = $("#positionBtn").val();
			let roomName = $("#join-roomName").val();
			let roomPassword = $("#join-roomPw").val();
			
			if(id == ""){
				alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
				return;
			}
			if(!checkDuplicate){
				alert("ì•„ì´ë”” ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”.");
				return;
			}
			if(password == ""){
				alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
				return;
			}
			if(Checkpassword == ""){
				alert("ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.")
				return
			}
			if(password != Checkpassword){
				alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ì¼ì¹˜í•˜ì§€ ì•Šì•„ìš”.");
				return;
			}
			
			if(name == "") {
				alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
				return;
			}
			if(position == ""){
				alert("ì§ì±…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
				return;
			}
			if(roomName == ""){
				alert("ì°¸ì—¬í•  ë°© ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”.");
				return;
			}
			if(roomPassword == ""){
				alert("ë°© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
				return
			}
			//ìˆëŠ” ë°©ì¸ì§€ ì—¬ë¶€ í™•ì¸
			$.ajax({
				type:"post"
				,url:"/room/duplicate-room"
				,data:{"roomName" : roomName, "roomPw" : roomPassword}
				,success:function(data){
					if(data.isDuplicate == true) {
						checkIsRoom = true;
						alert("ê°€ì…ê°€ëŠ¥");	
					} else {
						checkIsRoom = false;
						alert("ê°€ì…ë¶ˆê°€.");
					}
				}, error:function(){
					alert("ë°© ì¤‘ë³µì—¬ë¶€ í™•ì¸ ì—ëŸ¬!");
				}
			})
			
			let formData = new FormData();
			formData.append("join-idInput", id);
			formData.append("join-checkPwInput", Checkpassword);
			formData.append("join-userName", name);
			formData.append("profile", imgFile);
			formData.append("position", position);
			formData.append("join-roomName", roomName);
			formData.append("join-roomPw", roomPassword);
			
			$.ajax({
				type:"post"
				,url :"/user/join"
				,data:formData
				,enctype:"multiplart/form-data"
				,processData:false
    			,contentType:false
    			,success:function(data){
    				if(data.result == "success" && checkIsRoom == true){
    					location.href="/user/before-apply-view";
    				} else {
    					alert("íšŒì›ê°€ì… ì‹¤íŒ¨!");
    				}
				} ,error:function(){
					alert("íšŒì›ê°€ì… ì—ëŸ¬!");
    			}
			})
			
			$.ajax({
				 type: "post"
				,url: "/user/apply"
				,data : {"roomName" : roomName , "roomPassword" : roomPassword}
				,success : function(data){
					if(data.result == "success"){
						alert("ë¯¸ìŠ¹ì¸ ê°ì²´ ì¡°íšŒ ì„±ê³µ!");
					} else {
						alert("ë¯¸ìŠ¹ì¸ ê°ì²´ ì¡°íšŒ ì‹¤íŒ¨!");
					}
				}, error : function(){
					alert("ë¯¸ìŠ¹ì¸ ê°ì²´ ì¡°íšŒ ì—ëŸ¬!");
				}
			})
			
			
		})
	})
	</script>
</html>