<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{Layouts/contents}">
        
	<header layout:fragment="header">
		<th:block th:replace="~{fragments/header :: .leftheader}"></th:block>
	</header>
	
	<section layout:fragment="content" class="d-flex justify-content-center">
		<div class="join-content mt-4">
			<div class="joinDiv d-flex">
				<input type="text" class="join-roomInfo form-control col-7" 
						id="join_idInput" name ="join_idInput"  placeholder="ì•„ì´ë”” ì…ë ¥">
				<div class="profile-btn col-5" id="check-duplicateBtn">ì¤‘ë³µí™•ì¸</div>
			</div>
	
	
			<!-- ìœ íš¨ì„±ê²€ì‚¬ -->
			<!-- Id ìœ íš¨ì„±ê²€ì‚¬ -->
			<div class="availableText d-none" id="availableText1">ì‚¬ìš©ê°€ëŠ¥í•œ IDì…ë‹ˆë‹¤.</div>
			<div class="availableText d-none" id="availableText2">ì‚¬ìš©ê°€ëŠ¥í•œ IDì¡°ê±´ì…ë‹ˆë‹¤. ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”.</div>
			<div class="validation-text d-none" id="duplicateText">ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ IDì…ë‹ˆë‹¤.</div>
			<div class="validation-text d-none" id="failure-text1">ì‚¬ìš©ê°€ëŠ¥í•œ ê¸€ì ìˆ˜ëŠ” 7~12 ì…ë‹ˆë‹¤.</div>
			<div class="validation-text d-none" id="failure-text2">ì•„ì´ë””ëŠ” ì˜ë¬¸,ìˆ«ìì¡°í•©ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
			<div class="validation-text d-none" id="failure-text3">ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
			
			<div class="joinDiv">
				<input type="password" class="join-roomInfo form-control" id="join_PwInput" name ="join_PwInput" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
			</div>
			
			<!-- ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„±ê²€ì‚¬ -->
			<div class="validation-text d-none" id="failure-text4">ë¹„ë°€ë²ˆí˜¸ëŠ” 8ê¸€ì ì´ìƒ, ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
			<div class="availableText d-none" id="availableText4">ì‚¬ìš©ê°€ëŠ¥í•œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.</div>
						
			<div class="joinDiv">
				<input type="password" class="join-roomInfo form-control" id="join_checkPwInput" name="join_checkPwInput"  placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
			</div>
			
			<!-- ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ì—¬ë¶€í™•ì¸ -->
			<div class="validation-text d-none" id="failure-text5">ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
			<div class="availableText d-none" id="availableText5">ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.</div>

			<div class="joinDiv d-flex">
				<input type="text" class="join-roomInfo form-control col-6" id="join_userName" name="join_userName"  placeholder="ì´ë¦„">
				
				<label for="imgFile" class="profile-btn col-6 p-0">í”„ë¡œí•„ ì‚¬ì§„ ì„ íƒ</label>
				
				<input type="file" id="imgFile" name="profile"  style="display:none">
			</div>
			
			<div class="joinDiv">
				<div>
					<input class="dropdown-toggle" id="positionBtn" type="text" data-toggle="dropdown" aria-expanded="false" placeholder="ì§ì±… ì„ íƒ" name="positionBtn" value="">
		  			<div class="dropdown-menu">
		    			<a class="dropdown-item" href="#" value="join-team-leader">íŒ€ì¥</a>
		    			<a class="dropdown-item" href="#" value="join-team-member">íŒ€ì›</a>
		  			</div>
	  			</div>
			</div>
						
			<div class="joinDiv-room d-none">
				<div class="joinDiv">
					<input type="text" class="join-roomInfo form-control" id="join_roomName" name="join_roomName"  placeholder="ë°© ì´ë¦„">
				</div>
				<div class="joinDiv">
					<input type="password" class="join-roomInfo form-control" id="join_roomPw" name="join_roomPw"  placeholder="ë°© ë¹„ë°€ë²ˆí˜¸ğŸ”‘">
				</div>
			</div>
			<div class="joinDiv d-flex justify-content-end">
				<div id="join-accountBtn">ê³„ì •ë§Œë“¤ê¸°</div>
			</div>
		</div>
	</section>
	
	<script layout:fragment ="script">
		//drop-downì˜ valueê°’ ë„£ê¸°
		$(".dropdown-menu > a").on('click',function(){
			
			$("#positionBtn").attr('value', $(this).text());
			let value = $("#positionBtn").val();
			
			if(value == "íŒ€ì¥") {
				$(".joinDiv-room").addClass("d-none");
				return;
			} else {
				$(".joinDiv-room").removeClass("d-none");
				return;
			}
		})
		
		//ì•„ì´ë”” : ê¸€ì ìˆ˜ ì œí•œ
		function idLength(str){
			return str.length >= 7 && str.length <= 12;
		}
		//ì•„ì´ë”” : ì˜ì–´ ë˜ëŠ” ìˆ«ìë§Œ ê°€ëŠ¥
		function onlyNumberAndEnglish(str){
			return /^[A-Za-z0-9][A-Za-z0-9]*$/.test(str);
		}
		//ë¹„ë°€ë²ˆí˜¸ : 8ê¸€ìì´ìƒ, ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš©
		function strongPassword(str) {
			  return /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/.test(str);
		}
		//ë¹„ë°€ë²ˆí˜¸ : ì¼ì¹˜ì—¬ë¶€
		function isMatch(password1, password2) {
			  return password1 == password2;
		}
			
		$(document).ready(function(){	
    		//ì¤‘ë³µí™•ì¸ ì—¬ë¶€
    		var checkDuplicate = false; 		
    		//ì¤‘ë³µì—¬ë¶€
    		var isDuplicatedId = true; 
    
    		//ì•„ì´ë”” ê²€ì¦
    		new Promise((succ, fail) => {
    			$("#join_idInput").on('keyup', function(){
        			let loginId = $("#join_idInput").val();
        			if(loginId != ""){
        				if(idLength(loginId) == false){
        					$("#failure-text1").removeClass("d-none");
        					$("#failure-text2").addClass("d-none");
        					$("#availableText2").addClass("d-none");
        				}
        				else if(onlyNumberAndEnglish(loginId) == false){
        					$("#failure-text1").addClass("d-none");
        					$("#failure-text2").removeClass("d-none");
        					$("#availableText2").addClass("d-none");
        				}
        				else if(idLength(loginId) == true && onlyNumberAndEnglish(loginId) == true){
        					$("#availableText2").removeClass("d-none");
        					$("#failure-text1").addClass("d-none");
        					$("#failure-text2").addClass("d-none");
        					succ("ìœ íš¨ì„± ê²€ì¦ ì™„ë£Œ");
        				}
        				else {
        					$("#failure-text1").addClass("d-none");
        					$("#failure-text2").addClass("d-none");
        					$("#availableText2").addClass("d-none");
        				}
        			}    			
    			})
    		}).then((arg) => {
    			console.log(arg);
    			//Idì¤‘ë³µí™•ì¸
        		$("#join_idInput").on("input", function(){			
        			//ì…ë ¥ì´ ë°”ë€Œë©´ ì¤‘ë³µì²´í¬ë¥¼ ë‹¤ì‹œí•´ì•¼í•¨ , ì¤‘ë³µí™•ì¸ê³¼ì • ì´ˆê¸°í™”
        			checkDuplicate = false;
        			isDuplicatedId = true;
        		})
        		
        		$("#check-duplicateBtn").on('click',function(){
        			let loginId = $("#join_idInput").val();
        			
        			$.ajax({
        				type:"get"
        				,url:"/user/duplicate-id"
        				,data:{"join_idInput" : loginId}
        				,success:function(data){
        					if(data.isDuplicate == true){
        						checkDuplicate = true;
        						isDuplicatedId = true;
        						$("#duplicateText").removeClass("d-none");
        						$("#availableText1").addClass("d-none");
        					} else {
        						checkDuplicate = true;
        						isDuplicatedId = false;
        						$("#duplicateText").addClass("d-none");
        						$("#availableText1").removeClass("d-none");
        						$("#availableText2").addClass("d-none");
        					}
        				}, error:function(){
        					alert("ì¤‘ë³µí™•ì¸ ì—ëŸ¬!");
        				}
        			})
        		})    			
    		})
    		new Promise((succ, fail) => {
    		//ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
    			$("#join_PwInput").on('keyup', function(){
					let password = $("#join_PwInput").val();
				
					if(password != ""){
						if(strongPassword(password) == false){
							$("#failure-text4").removeClass("d-none");
							$("#failure-text5").addClass("d-none");
							return;
						} 
						else if(strongPassword(password) == true){	
							$("#availableText4").removeClass("d-none");
							$("#failure-text4").addClass("d-none");
							$("#failure-text5").addClass("d-none");
							succ(password);
							return;
						}
						else {
							$("#availableText4").addClass("d-none");
							$("#failure-text4").addClass("d-none");
							$("#failure-text5").addClass("d-none");
							succ("ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì¦ ì™„ë£Œ")
						}
					}
    			})
			}).then((arg) => {
				//ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ì—¬ë¶€ í™•ì¸
				console.log(arg);
				$("#join_checkPwInput").on('keyup', function(){
					let password = $("#join_PwInput").val();
					let Checkpassword = $("#join_checkPwInput").val();
					if(isMatch(arg, Checkpassword) == false) {
						$("#failure-text4").addClass("d-none");
						$("#failure-text5").removeClass("d-none");
						$("#availableText5").addClass("d-none");
						return;
					} 
					else if(isMatch(arg, Checkpassword) == true) {
						$("#failure-text4").addClass("d-none");
						$("#failure-text5").addClass("d-none");
						$("#availableText5").removeClass("d-none");
						return;
					}
					else {
						$("#failure-text4").addClass("d-none");
						$("#failure-text5").addClass("d-none");
						$("#availableText5").addClass("d-none");
					}
				})
			})			
    		//ê³„ì •ë§Œë“¤ê¸°
		$("#join-accountBtn").on('click',function(){
			let id = $("#join_idInput").val();
			let password = $("#join_PwInput").val();
			let Checkpassword = $("#join_checkPwInput").val();
			let name = $("#join_userName").val();
			let imgFile = $("#imgFile")[0].files[0];
			let position = $("#positionBtn").val();
			let roomName = null;
			let roomPassword = null;
			
			if(id == ""){
				alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
				return;
			}
			if(!checkDuplicate){
				alert("ì•„ì´ë”” ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”.");
				return;
			}
			if(password == ""){
				alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
				return;
			}
			if(Checkpassword == ""){
				alert("ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.")
				return
			}
			if(password != Checkpassword){
				alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ì¼ì¹˜í•˜ì§€ ì•Šì•„ìš”.");
				return;
			}
			
			if(name == "") {
				alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
				return;
			}
			if(position == ""){
				alert("ì§ì±…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
				return;
			}
			
			if(position == "íŒ€ì›"){
				if(roomName == ""){
					alert("ì°¸ì—¬í•  ë°© ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”.");
					return;
				}
				if(roomPassword == ""){
					alert("ë°© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
					return
				}
				roomName = $("#join_roomName").val();
				roomPassword = $("#join_roomPw").val();
				
				new Promise((succ, fail) => {
					//ë°© ì¤‘ë³µì¸ì§€ í™•ì¸, í™•ì¸ì´ ë˜ì–´ì•¼ ê°€ì…ê°€ëŠ¥
					$.ajax({
						type:"post"
						,url : "/room/duplicate-room"
						,data : {"roomName" : roomName, "roomPw" : roomPassword}
						,success : function(data){
							if(data.isDuplicate == true){
								succ("ë°©ìˆìŒ");
							} else {
								fail("ê·¸ëŸ°ë°© ì—†ì–´ìš”");
							}
						}
						,error : function(){
							fail("ë°© ì¤‘ë³µì—¬ë¶€ ì˜¤ë¥˜");
						}
					})
				}).then((arg) => {
					//ë°ì´í„° ë„˜ê¸°ê¸°
					let formData = new FormData();
					formData.append("join_idInput", id);
					formData.append("join_checkPwInput", Checkpassword);
					formData.append("join_userName", name);
					formData.append("profile", imgFile);
					formData.append("position", position);
					formData.append("join_roomName", roomName);
					formData.append("join_roomPw", roomPassword);
					
					$.ajax({
						type:"post"
						,url :"/user/join"
						,data:formData
						,enctype:"multiplart/form-data"
						,processData:false
		    			,contentType:false
		    			,success:function(data){
		    				if(arg == "ë°©ìˆìŒ") {
		    					location.href = "/member/before-apply-view";
		    					alert("íŒ€ì› íšŒì›ê°€ì… ì„±ê³µ!");
		    				} else {
		    					alert("íŒ€ì› íšŒì›ê°€ì… ì‹¤íŒ¨!");
		    				}
		    			}
						,error : function(){
							alert("íŒ€ì› íšŒì›ê°€ì… ì—ëŸ¬!");
						}
					})	
				})
				.catch((error) => {
					alert(error);
				})
			}
			if(position == "íŒ€ì¥"){
				let formData = new FormData();
				formData.append("join_idInput", id);
				formData.append("join_checkPwInput", Checkpassword);
				formData.append("join_userName", name);
				formData.append("profile", imgFile);
				formData.append("position", position);
				formData.append("join_roomName", roomName);
				formData.append("join_roomPw", roomPassword);
					
				$.ajax({
					type:"post"
					,url :"/user/join"
					,data:formData
					,enctype:"multiplart/form-data"
					,processData:false
		    		,contentType:false
		    		,success:function(data){
		    			console.log(data);
		    			if(data.result == "hasError"){
		    				location.href="/user/join-view";
	    					alert(data);
		    			}
		    			else if(data.result == "success"){
		    				location.href="/leader/login-view";
		    				alert("íŒ€ì¥ íšŒì›ê°€ì… ì„±ê³µ!");
		    			} else {
		    				alert("íŒ€ì¥ íšŒì›ê°€ì… ì‹¤íŒ¨");
		    			}
		    		},error : function(){
		    			alert("íŒ€ì¥ íšŒì›ê°€ì… ì—ëŸ¬!");
		    		}
				})
			}
		})
	})
	</script>
</html>